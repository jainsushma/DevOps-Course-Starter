name: To Do app CI/CD
on: [push]

jobs:
  build:
    name: Build and test
    runs-on: ubuntu-latest
    env:
        TOKEN: ${{ secrets.TOKEN }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
    steps:
    - uses: actions/checkout@v2

    - name: Build
      run: docker build --target test --tag todo-app:test .

    - name: Unit/Integration Test
      run: docker run todo-app:test tests
    
    - name: End to End Test
      run: docker run -e SECRET_KEY -e TOKEN todo-app:test tests_e2e

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    env:
        docker_hub_password: ${{ secrets.docker_hub_password }}
        docker_hub_username: ${{ secrets.docker_hub_username }}
    needs: build
    # if: github.ref == 'refs/heads/master' # include this line if you want to limit the deployment to the master branch
    steps:
    - uses: actions/checkout@v2

    - name: Login to DockerHub
      run: echo $docker_hub_password | docker login --username $docker_hub_username --password-stdin
    
    - name: Build the Docker image
      run: docker build --target production --tag sjain309/todo-app-prod:latest .

    - name: Push the Docker image to DockerHub
      run: docker push sjain309/todo-app-prod:latest

    - name: Pull the Docker image from DockerHub
      run: docker pull sjain309/todo-app-prod

    - name: Tag the Docker image for Heroku
      run: docker tag sjain309/todo-app-prod registry.heroku.com/heroku-app-devops/web

    - name: Login to Heroku container
      run: heroku container:login

    - name: Push it to Heroku registry
      run: docker push registry.heroku.com/heroku-app-devops/web

    - name: Release Heroku container
      run: heroku container:release web --app heroku-app-devops



